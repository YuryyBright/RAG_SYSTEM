<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>POWERFULL AI MANAGER | Login</title>

    <!-- iCheck Bootstrap -->
    <link rel="stylesheet" href="{{ url_for('static', path='plugins/icheck-bootstrap/icheck-bootstrap.min.css') }}" />
    <link rel="stylesheet" href="{{ url_for('static', path='plugins/fontawesome-free/css/all.min.css') }}" />

    <!-- Theme Style -->
    <link rel="stylesheet" href="{{ url_for('static', path='dist/css/adminlte.min.css') }}" />
  </head>
  <body class="hold-transition login-page dark-mode">
    <div class="login-box">
      <!-- Logo -->
      <div class="login-logo">
        <a href="/">
          <b>POWERFUL AI</b>
          MANAGER
        </a>
      </div>

      <!-- Card -->
      <div class="card">
        <div class="card-body login-card-body">
          <p class="login-box-msg" id="form-title">Sign in to start your session</p>

          <!-- Login Form -->
          <form id="login-form" action="/api/auth/login" method="post">
            <div class="input-group mb-3">
              <input type="email" class="form-control" placeholder="Email" name="email" required />
              <div class="input-group-append">
                <div class="input-group-text">
                  <span class="fas fa-envelope"></span>
                </div>
              </div>
            </div>
            <div class="input-group mb-3">
              <input type="password" class="form-control" placeholder="Password" name="password" required />
              <div class="input-group-append">
                <div class="input-group-text">
                  <span class="fas fa-lock"></span>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-8">
                <div class="icheck-primary">
                  <input type="checkbox" id="remember" name="remember" />
                  <label for="remember">Remember Me</label>
                </div>
              </div>
              <div class="col-4">
                <button type="submit" class="btn btn-primary btn-block">Sign In</button>
              </div>
            </div>
          </form>

          <!-- Register Form (hidden by default) -->
          <form id="register-form" action="/api/auth/register" method="post" class="d-none">
            <div class="input-group mb-3">
              <input type="text" class="form-control" placeholder="Full name" name="name" required />
              <div class="input-group-append">
                <div class="input-group-text">
                  <span class="fas fa-user"></span>
                </div>
              </div>
            </div>
            <div class="input-group mb-3">
              <input type="email" class="form-control" placeholder="Email" name="email" required />
              <div class="input-group-append">
                <div class="input-group-text">
                  <span class="fas fa-envelope"></span>
                </div>
              </div>
            </div>
            <div class="input-group mb-3">
              <input type="password" class="form-control" placeholder="Password" name="password" required />
              <div class="input-group-append">
                <div class="input-group-text">
                  <span class="fas fa-lock"></span>
                </div>
              </div>
            </div>
            <div class="input-group mb-3">
              <input
                type="password"
                class="form-control"
                placeholder="Confirm password"
                name="password_confirm"
                required
              />
              <div class="input-group-append">
                <div class="input-group-text">
                  <span class="fas fa-lock"></span>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-8">
                <div class="icheck-primary">
                  <input type="checkbox" id="agreeTerms" name="terms" required />
                  <label for="agreeTerms">
                    I agree to the
                    <a href="#">terms</a>
                  </label>
                </div>
              </div>
              <div class="col-4">
                <button type="submit" class="btn btn-primary btn-block">Register</button>
              </div>
            </div>
          </form>

          <p class="mb-1">
            <a href="#" id="forgot-password-link">I forgot my password</a>
          </p>
          <p class="mb-0">
            <a href="#" id="toggle-form" class="text-center">Register a new membership</a>
          </p>
        </div>
      </div>

      <!-- Alerts -->
      <div id="alert-container" class="mt-3"></div>
    </div>

    <!-- jQuery -->
    <script src="{{ url_for('static', path='plugins/jquery/jquery.min.js') }}"></script>
    <!-- Bootstrap 4 -->
    <script src="{{ url_for('static', path='plugins/bootstrap/js/bootstrap.bundle.min.js') }}"></script>
    <!-- App -->
    <script src="{{ url_for('static', path='dist/js/adminlte.min.js') }}"></script>
    <script src="{{ url_for('static', path='plugins/alertify.js/js/alertify.js') }}"></script>
    <!-- Authentication script -->
    <script src="{{ url_for('static', path='/dist/js/pages/auth.js') }}"></script>
    <script>
      $(document).ready(function () {
        // Toggle between login and register forms
        $("#toggle-form").click(function (e) {
          e.preventDefault();

          if ($("#login-form").hasClass("d-none")) {
            // Switch to login form
            $("#login-form").removeClass("d-none");
            $("#register-form").addClass("d-none");
            $("#form-title").text("Sign in to start your session");
            $(this).text("Register a new membership");
          } else {
            // Switch to register form
            $("#login-form").addClass("d-none");
            $("#register-form").removeClass("d-none");
            $("#form-title").text("Register a new membership");
            $(this).text("I already have a membership");
          }
        });

        // Handle login form submission
        // Handle login form submission
        $("#login-form").submit(function (e) {
          e.preventDefault();

          const email = $(this).find('input[name="email"]').val();
          const password = $(this).find('input[name="password"]').val();
          const remember = $(this).find('input[name="remember"]').is(":checked");

          // Use AuthManager's login method instead of direct AJAX
          AuthManager.loginWithSession(email, password, remember)
            .then(function (response) {
              // Redirect to dashboard on success
              window.location.href = "/dashboard";
            })
            .catch(function (xhr) {
              // Show error message
              alertify.error("Login failed: " + (xhr.responseJSON?.detail || "Unknown error"));
            });
        });

        // Handle register form submission
        $("#register-form").submit(function (e) {
          e.preventDefault();

          const password = $(this).find('input[name="password"]').val();
          const confirmPassword = $(this).find('input[name="password_confirm"]').val();

          if (password !== confirmPassword) {
            alertify.error("Passwords do not match!");
            return;
          }

          const formData = {
            name: $(this).find('input[name="name"]').val(),
            email: $(this).find('input[name="email"]').val(),
            password: password,
          };

          $.ajax({
            url: $(this).attr("action"),
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify(formData),
            success: function (response) {
              alertify.success("Registration successful! Please login.");
              // Switch back to login form
              $("#login-form").removeClass("d-none");
              $("#register-form").addClass("d-none");
              $("#form-title").text("Sign in to start your session");
              $("#toggle-form").text("Register a new membership");
            },
            error: function (xhr) {
              // Show error message
              alertify.error("Registration failed: " + xhr.responseText);
            },
          });
        });

        // Handle forgot password
        $("#forgot-password-link").click(function (e) {
          e.preventDefault();
          const email = prompt("Enter your email address:");

          if (email) {
            $.ajax({
              url: "/api/auth/reset-password",
              type: "POST",
              contentType: "application/json",
              data: JSON.stringify({ email: email }),
              success: function () {
                alertify.success("Password reset link sent to your email!");
              },
              error: function (xhr) {
                alertify.error("Failed to send reset link: " + xhr.responseText);
              },
            });
          }
        });
      });
    </script>
  </body>
</html>
